---
title: "Practice Dec 12, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache= TRUE, autodep = TRUE)
library(rethinking)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Problem 1

Remember the tomato data set generated by Pepe; we first looked at this when we were working on Chapter 9.  35 accessions for seven species were grown in sun and shade.  

Assess whether there is evidence for total length ("totleng") response to shade and whether this response varies by species.  Consider whether including accession ("acs"), shelf ("shelf"), and/or flat ("flat") using adaptive priors improves the model fit.

```{r}
tomato <- read.csv("Assignment_Chapter_09/TomatoR2CSHL.csv")
names(tomato)
tomato$species_id <- coerce_index(tomato$species)
tomato$shade <- ifelse(tomato$trt=="L",1,0)
tomato$shelf_id <- coerce_index(tomato$shelf)
tomato$species_id <- coerce_index(tomato$species)
tomato$acs_id <- coerce_index(tomato$acs)
tomato$flat_id <- coerce_index(tomato$flat)
tomato.small <- tomato[,c("shelf_id","flat_id","acs_id","shade","totleng","species_id")]
summary(tomato.small)

```

```{r}
mean(tomato.small$totleng)
m.shade <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      beta_shade*shade,
    alpha ~ dnorm(53,20),
    beta_shade ~ dnorm(0,20),
    sigma ~ dcauchy(0,1)
  ),
  data = tomato.small,
  chains=4
)
```

```{r}
plot(m.shade)
pairs(m.shade)
precis(m.shade)
```


```{r}
m.shade.species <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      beta_sp[species_id] + 
      beta_shade*shade,
    alpha ~ dnorm(53,20),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    sigma ~ dcauchy(0,1)
  ),
  data = tomato.small,
  chains=4
)
```

```{r}
plot(m.shade.species)
pairs(m.shade.species)
precis(m.shade.species,depth = 2)
compare(m.shade,m.shade.species) 
levels(tomato$species)
```

Good evidence for species being important

```{r}
m.shade.species.int <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      beta_sp[species_id] + 
      beta_shade*shade + 
      beta_sp_shade[species_id]*shade,
    alpha ~ dnorm(53,20),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    beta_sp_shade[species_id] ~ dnorm(0,10),
    sigma ~ dcauchy(0,1)
  ),
  data = tomato.small,
  chains=4,
  cores=2
)
```

```{r}
plot(m.shade.species.int)
precis(m.shade.species.int,depth=2)
levels(tomato$species)
compare(m.shade,m.shade.species,m.shade.species.int)
```

Strong evidence for the interaction

### Add adaptive prior for accessions

```{r}
m.shade.species.int.acs <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      alpha_acs[acs_id] +
      beta_sp[species_id] + 
      beta_shade*shade + 
      beta_sp_shade[species_id]*shade,
    alpha ~ dnorm(53,20),
    alpha_acs[acs_id] ~ dnorm(0,sigma_acs),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    beta_sp_shade[species_id] ~ dnorm(0,10),
    c(sigma,sigma_acs) ~ dcauchy(0,1)
  ),
  data = tomato.small,
  iter = 4000, # Rhat a bit high with defaults
  warmup = 1000,
  chains=4,
  cores=2
)
```


```{r}
plot(m.shade.species.int.acs,ask=FALSE)
par(mfrow=c(1,1))
precis(m.shade.species.int.acs,depth = 2)
compare(m.shade.species.int,m.shade.species.int.acs)
coeftab(m.shade.species.int,m.shade.species.int.acs)
plot(coeftab(m.shade.species.int,m.shade.species.int.acs),pars=1:13)
```

```{r}
m.shade.species.int.acs.shelf <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      alpha_acs[acs_id] +
      alpha_shelf[shelf_id]  +
      beta_sp[species_id] + 
      beta_shade*shade + 
      beta_sp_shade[species_id]*shade,
    alpha ~ dnorm(53,20),
    alpha_acs[acs_id] ~ dnorm(0,sigma_acs),
    alpha_shelf[shelf_id] ~ dnorm(0,sigma_shelf),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    beta_sp_shade[species_id] ~ dnorm(0,10),
    c(sigma,sigma_acs,sigma_shelf) ~ dcauchy(0,1)
  ),
  data = tomato.small,
  iter = 4000, # Rhat a bit high with defaults
  warmup = 1000,
  chains=4,
  cores=2
)
```

```{r}
plot(m.shade.species.int.acs.shelf,ask=FALSE)
par(mfrow=c(1,1))
precis(m.shade.species.int.acs.shelf,depth = 2)
compare(m.shade.species.int.acs,m.shade.species.int.acs.shelf)
coeftab(m.shade.species.int.acs,m.shade.species.int.acs.shelf)
plot(coeftab(m.shade.species.int.acs,m.shade.species.int.acs.shelf),pars=c(1,38:50))
```

```{r}
m.shade.species.int.acs.shelf.flat <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      alpha_acs[acs_id] +
      alpha_shelf[shelf_id]  +
      alpha_flat[flat_id] +
      beta_sp[species_id] + 
      beta_shade*shade + 
      beta_sp_shade[species_id]*shade,
    alpha ~ dnorm(53,20),
    alpha_acs[acs_id] ~ dnorm(0,sigma_acs),
    alpha_shelf[shelf_id] ~ dnorm(0,sigma_shelf),
    alpha_flat[flat_id] ~ dnorm(0,sigma_flat),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    beta_sp_shade[species_id] ~ dnorm(0,10),
    c(sigma,sigma_acs,sigma_shelf,sigma_flat) ~ dcauchy(0,1)
  ),
  data = tomato.small,
  iter = 4000, # Rhat a bit high with defaults
  warmup = 1000,
  chains=4,
  cores=2
)
```

```{r}
plot(m.shade.species.int.acs.shelf.flat,ask=FALSE)
par(mfrow=c(1,1))
precis(m.shade.species.int.acs.shelf.flat,depth = 2)
compare(m.shade.species.int.acs.shelf.flat,m.shade.species.int.acs.shelf)
coeftab(m.shade.species.int.acs.shelf.flat,m.shade.species.int.acs.shelf)
plot(coeftab(m.shade.species.int.acs.shelf.flat,m.shade.species.int.acs.shelf),pars=c(1,79:91))
```

So is the interaction still important?

```{r}
m.shade.species.acs.shelf.flat <- map2stan(
  alist(
    totleng ~ dnorm(mu,sigma),
    mu <- alpha + 
      alpha_acs[acs_id] +
      alpha_shelf[shelf_id]  +
      alpha_flat[flat_id] +
      beta_sp[species_id] + 
      beta_shade*shade,
    alpha ~ dnorm(53,20),
    alpha_acs[acs_id] ~ dnorm(0,sigma_acs),
    alpha_shelf[shelf_id] ~ dnorm(0,sigma_shelf),
    alpha_flat[flat_id] ~ dnorm(0,sigma_flat),
    beta_sp[species_id] ~ dnorm(0,10),
    beta_shade ~ dnorm(0,20),
    c(sigma,sigma_acs,sigma_shelf,sigma_flat) ~ dcauchy(0,1)
  ),
  data = tomato.small,
  iter = 4000, # Rhat a bit high with defaults
  warmup = 1000,
  chains=4,
  cores=2
)
```
```{r}
plot(m.shade.species.acs.shelf.flat,ask=FALSE)
par(mfrow=c(1,1))
precis(m.shade.species.acs.shelf.flat,depth = 2)
compare(m.shade.species.int.acs.shelf.flat,m.shade.species.acs.shelf.flat)
coeftab(m.shade.species.int.acs.shelf.flat,m.shade.species.acs.shelf.flat)
plot(coeftab(m.shade.species.int.acs.shelf.flat,m.shade.species.int.acs.shelf),pars=c(1,79:91))
```


## Smoking deaths among doctors

In 1961 Doll and Hill sent out a questionnaire to all men on the British Medical Register inquiring about their smoking habits. Almost 70% of such men replied. Death certificates were obtained for medical practitioners and causes of death were assigned on the basis of these certificates. The breslow data set contains the person-years of observations and deaths from coronary artery disease accumulated during the first ten years of the study.

Analyse this data set to determine the posterior probability that smoking increases death by coronary artery disease, that age increases death by coronary artery disease, and that there is an interaction between age and smoking.

You can load the data set and learn about the columns using the commands below

```{r}
data("breslow",package = "boot")
help("breslow",package ="boot")
breslow
```

You can think of "person-years" as the number of observations

Note: You almost certainly have the `boot` package on your computer, but if you do not have the `boot` package on your computer then you will need to `install.packages("boot")`

Note: do NOT do `library(boot)`.  This will make the `logit` function from boot over-ride the one from `rethinking`

## Cane Sugar

This data comes from an experiment to measure disease resistance in different varieties of sugar cane.

You can get the data and learn about it with:

```{r}
data("cane",package="boot")
help("cane",package="boot")
head(cane)
summary(cane)
```


Is there evidence of differences in disease resistance in the different varieties?  Does including an adaptive prior for Block improve the model fit?