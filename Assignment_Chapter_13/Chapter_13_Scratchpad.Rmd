---
title: "Chapter 13 Scratchpad"
output: html_notebook
---

```{r}
library(rethinking)
library(ggplot2)
library(brms)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
knitr::opts_chunk$set(cache=TRUE,autodep=TRUE)
```


```{r 13.1}
a <- 3.5 # average morning wait time
b <- (-1) # average difference afternoon wait time
sigma_a <- 1 # std dev in intercepts
sigma_b <- 0.5 # std dev in slopes
rho <- (-0.7) # correlation between intercepts and slopes
```

```{r 13.2}
Mu <- c( a , b )
```

```{r 13.3}
cov_ab <- sigma_a*sigma_b*rho
Sigma <- matrix( c(sigma_a^2,cov_ab,cov_ab,sigma_b^2) , ncol=2 )
```

```{r 13.5}
sigmas <- c(sigma_a,sigma_b) # standard deviations
sigmas

Rho <- matrix( c(1,rho,rho,1) , nrow=2 ) # correlation matrix
Rho

diag(sigmas)
diag(sigmas) %*% Rho
Rho %*% diag(sigmas) 


# now matrix multiply to get covariance matrix
Sigma <- diag(sigmas) %*% Rho %*% diag(sigmas)
Sigma

```


```{r 13.6_7}
N_cafes <- 20
library(MASS)
set.seed(5) # used to replicate example
vary_effects <- mvrnorm( N_cafes , Mu , Sigma )
vary_effects
```

```{r 13.8_9}

a_cafe <- vary_effects[,1]
b_cafe <- vary_effects[,2]

plot( a_cafe , b_cafe , col=rangi2 ,
xlab="intercepts (a_cafe)" , ylab="slopes (b_cafe)" )
# overlay population distribution
library(ellipse)
for ( l in c(0.1,0.3,0.5,0.8,0.99) )
lines(ellipse(Sigma,centre=Mu,level=l),col=col.alpha("black",0.2))

#not quite the same: contours are based on actual data instead of Sigma matrix
pl <- qplot(x=a_cafe,y=b_cafe,color=I("skyblue"),geom="point")
pl + geom_density_2d(bins=5)
```

```{r 13.10}
N_visits <- 10
afternoon <- rep(0:1,N_visits*N_cafes/2)
cafe_id <- rep( 1:N_cafes , each=N_visits )
mu <- a_cafe[cafe_id] + b_cafe[cafe_id]*afternoon
sigma <- 0.5 # std dev within cafes
wait <- rnorm( N_visits*N_cafes , mu , sigma )
d <- data.frame( cafe=cafe_id , afternoon=afternoon , wait=wait )
head(d)
summary(d)
```

```{r 13.12}
m13.1 <- map2stan(
    alist(
        wait ~ dnorm( mu , sigma ),
        mu <- a_cafe[cafe] + b_cafe[cafe]*afternoon,
        c(a_cafe,b_cafe)[cafe] ~ dmvnorm2(c(a,b),sigma_cafe,Rho),
        a ~ dnorm(0,10),
        b ~ dnorm(0,10),
        sigma_cafe ~ dcauchy(0,2),
        sigma ~ dcauchy(0,2),
        Rho ~ dlkjcorr(2)
),
data=d ,
iter=5000 , warmup=2000 , chains=2 )
```

```{r 13.12.brms}
m13.1.brms <- brm(wait ~ 1 + afternoon + (afternoon|cafe),
                   prior = c(set_prior("normal(0,10)",class="Intercept"),
                             set_prior("normal(0,10)",class="b"),
                             set_prior("cauchy(0,2)", class="sd"),
                             set_prior("cauchy(0,2)", class = "sigma"),
                             set_prior("lkj(2)", class = "cor")),
                  data=d,
                  iter = 5000,
                  warmup = 2000,
                  chains = 2)
```

```{r}
precis(m13.1,depth=2)
print("---------------------")
summary(m13.1.brms)
```

```{r}
cbind(brms.intercept=coef(m13.1.brms)$cafe[,1],map2stan.intercept=coef(m13.1)[21:40])
cor(coef(m13.1.brms)$cafe[,1],coef(m13.1)[21:40])

cbind(brms.afternoon=coef(m13.1.brms)$cafe[,2],map2stanl.afternoon=coef(m13.1)[1:20])
cor(coef(m13.1.brms)$cafe[,2],coef(m13.1)[1:20])
```

Coefficients are ~ equivalent

```{r 13.13}
post <- extract.samples(m13.1)
dens( post$Rho[,1,2] )
```

```{r 13.14-15}
# compute unpooled estimates directly from data
a1 <- sapply( 1:N_cafes ,
        function(i) mean(wait[cafe_id==i & afternoon==0]) )
b1 <- sapply( 1:N_cafes ,
        function(i) mean(wait[cafe_id==i & afternoon==1]) ) - a1
# extract posterior means of partially pooled estimates
post <- extract.samples(m13.1)
a2 <- apply( post$a_cafe , 2 , mean )
b2 <- apply( post$b_cafe , 2 , mean )
# plot both and connect with lines
plot( a1 , b1 , xlab="intercept" , ylab="slope" ,
    pch=16 , col=rangi2 , ylim=c( min(b1)-0.1 , max(b1)+0.1 ) ,
    xlim=c( min(a1)-0.1 , max(a1)+0.1 ) )
points( a2 , b2 , pch=1 )
for ( i in 1:N_cafes ) lines( c(a1[i],a2[i]) , c(b1[i],b2[i]) )

# compute posterior mean bivariate Gaussian
Mu_est <- c( mean(post$a) , mean(post$b) )
rho_est <- mean( post$Rho[,1,2] )
sa_est <- mean( post$sigma_cafe[,1] )
sb_est <- mean( post$sigma_cafe[,2] )
cov_ab <- sa_est*sb_est*rho_est
Sigma_est <- matrix( c(sa_est^2,cov_ab,cov_ab,sb_est^2) , ncol=2 )
# draw contours
library(ellipse)
for ( l in c(0.1,0.3,0.5,0.8,0.99) )
    lines(ellipse(Sigma_est,centre=Mu_est,level=l),
        col=col.alpha("black",0.2))
```

```{r 13.17}
data(UCBadmit)
d <- UCBadmit
d$male <- ifelse( d$applicant.gender=="male" , 1 , 0 )
d$dept_id <- coerce_index( d$dept )
```

```{r 13.18}
m13.2 <- map2stan(
    alist(
        admit ~ dbinom( applications , p ),
        logit(p) <- a_dept[dept_id] + bm*male,
        a_dept[dept_id] ~ dnorm( a , sigma_dept ),
        a ~ dnorm(0,10),
        bm ~ dnorm(0,1),
        sigma_dept ~ dcauchy(0,2)
),
    data=d , warmup=500 , iter=4500 , chains=3 )
```

Try it in brms
```{r}
m13.2.brms <- brm(admit | trials(applications) ~ (1|dept) + applicant.gender,
                  family = "binomial",
                  prior = c(set_prior("normal(0,10)", class = "Intercept"),
                            set_prior("normal(0,1)", class = "b"),
                            set_prior("cauchy(0,2)", class = "sd")),
                  data=d,
                  warmup=500,
                  iter=4500,
                  chains=3)
```
```{r}
precis( m13.2 , depth=2 ) # depth=2 to display vector parameters
print("------------")
summary(m13.2.brms)
coef(m13.2.brms)
```


same

```{r 13.19}
m13.3 <- map2stan(
    alist(
        admit ~ dbinom( applications , p ),
        logit(p) <- a_dept[dept_id] +
                    bm_dept[dept_id]*male,
        c(a_dept,bm_dept)[dept_id] ~ dmvnorm2( c(a,bm) , sigma_dept , Rho ),
        a ~ dnorm(0,10),
        bm ~ dnorm(0,1),
        sigma_dept ~ dcauchy(0,2),
        Rho ~ dlkjcorr(2)
),
data=d , warmup=1000 , iter=5000 , chains=4 , cores=3 )
```

```{r}
m13.3.brms <- brm(admit | trials(applications) ~ applicant.gender + (applicant.gender|dept),
                  family = "binomial",
                  prior = c(set_prior("normal(0,10)", class = "Intercept"),
                            set_prior("normal(0,1)", class = "b"),
                            set_prior("cauchy(0,2)", class = "sd"),
                            set_prior("lkj(2)", class = "cor")),
                  data=d,
                  warmup=500,
                  iter=4500,
                  chains=3)
```

```{r}
precis(m13.3,depth=2)
print("----------------")
summary(m13.3.brms)
```

```{r}
plot(m13.3,ask=FALSE)
```
```{r 13.20}
plot( precis(m13.3,pars=c("a_dept","bm_dept"),depth=2) )
```

```{r 13.21}
m13.4 <- map2stan(
    alist(
        admit ~ dbinom( applications , p ),
        logit(p) <- a_dept[dept_id],
        a_dept[dept_id] ~ dnorm( a , sigma_dept ),
        a ~ dnorm(0,10),
sigma_dept ~ dcauchy(0,2) ),
    data=d , warmup=500 , iter=4500 , chains=3 )
compare( m13.2 , m13.3 , m13.4 )
```

